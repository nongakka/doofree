<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>‡∏´‡∏£‡∏£‡∏°‡∏ô‡πâ‡∏≠‡∏¢ ‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå</title>

<link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600&display=swap" rel="stylesheet">

<script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
<script src="https://cdn.dashjs.org/latest/dash.all.min.js"></script>
<script src="https://ssl.p.jwpcdn.com/player/v/8.26.0/jwplayer.js"></script>
<script>jwplayer.key="XSuP4qMl+9tK17QNb+4+th2Pm9AWgMO/cYH8CI0HGGr7bdjo";</script>

<style>
:root{
--bg:#0f0f0f;
--card:#1b1b1b;
--accent:#f5c518;
}
*{box-sizing:border-box}
body{
margin:0;
font-family:'Kanit',sans-serif;
background:#0b0b0b;
color:#fff;
display:flex;
}

.playlist-box{
background:#222;
padding:8px;
margin-bottom:6px;
border-radius:6px;
cursor:pointer;
display:flex;
justify-content:space-between;
align-items:center;
gap:6px;
}

.playlist-name{
flex:1;
white-space:nowrap;
overflow:hidden;
text-overflow:ellipsis;
font-size:13px;
}

.playlist-actions{
display:flex;
gap:4px;
}

.playlist-actions button{
border:none;
padding:3px 6px;
border-radius:4px;
color:#fff;
cursor:pointer;
font-size:12px;
}

.playlist-box.active{
background:#333;
border-left:3px solid var(--accent);
}

/* SIDEBAR */
.sidebar{
  width:280px;
  background:#0f0f0f;
  height:100vh;
  padding:5px 20px 20px 20px; /* ‡∏•‡∏î padding-top */
  position:fixed;
  left:0;
  top:0;
  border-right:1px solid #222;
  overflow-y:auto;
  transition:.3s;
  z-index:100;
}


/* ‡∏õ‡∏∏‡πà‡∏° */

.sidebar-section{
  margin:12px 0;
  padding-bottom:15px;
  border-bottom:1px solid #1f1f1f;
  text-align:center;
}

.sidebar-section:last-child{
border-bottom:none;
}



.sidebar h3{
font-size:14px;
margin-bottom:5px;
color:#aaa;
text-transform:uppercase;
letter-spacing:.5px;
}

.sidebar input{
width:100%;
margin-bottom:8px;
padding:8px;
background:#1c1c1c;
border:1px solid #222;
color:#fff;
border-radius:6px;
}

.sidebar button{
width:100%;
padding:8px;
margin-bottom:4px;
background:var(--accent);
border:none;
border-radius:6px;
cursor:pointer;
font-weight:600;
}

.sidebar ul{
list-style:none;
padding:0;
margin:0;
}

#themeToggle{
  margin-bottom:6px;
}

.sidebar-section:first-of-type{
  margin-top:6px;
}

/* ===== CATEGORY MENU MODERN ===== */

#categoryList{
  display:flex;
  flex-direction:column;
  gap:8px;
}

#categoryList li{
  list-style:none;
  padding:10px 14px;
  border-radius:10px;
  cursor:pointer;
  font-size:13px;
  font-weight:400;
  display:flex;
  justify-content:space-between;
  align-items:center;
  background:#1a1a1a;
  transition:all .25s ease;
  border:1px solid #222;
}

#categoryList li:hover{
  background:#242424;
  transform:translateX(4px);
}

#categoryList li.active{
  background:linear-gradient(90deg,#3b82f6,#6366f1);
  border:none;
  box-shadow:0 5px 15px rgba(59,130,246,.25);
}

#categoryList li.active span{
  background:rgba(255,255,255,.2);
}

/* badge ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç */
.category-count{
  background:#333;
  padding:3px 8px;
  border-radius:20px;
  font-size:11px;
  font-weight:600;
}

.sidebar-section h2{
  font-size:18px;
  font-weight:600;
  letter-spacing:1px;
  margin:0;
  position:relative;
  display:inline-block;
  padding-bottom:8px;
}

/* ‡πÄ‡∏™‡πâ‡∏ô‡πÑ‡∏•‡πà‡∏™‡∏µ‡πÉ‡∏ï‡πâ‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠ */
.sidebar-section h2::after{
  content:"";
  position:absolute;
  left:50%;
  transform:translateX(-50%);
  bottom:0;
  width:60%;
  height:3px;
  border-radius:10px;
  background:linear-gradient(90deg,#ff512f,#dd2476);
}

/* ‡πÉ‡∏´‡πâ‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏≠‡∏¢‡∏π‡πà‡∏Å‡∏•‡∏≤‡∏á */
.sidebar-section h2,
.sidebar-section h3{
  text-align:center;
}

/* ‡πÅ‡∏ï‡πà‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ playlist ‡∏ä‡∏¥‡∏î‡∏ã‡πâ‡∏≤‡∏¢ */
#playlistContainer{
  text-align:left;
}

/* ‡πÅ‡∏ï‡πà‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏ä‡∏¥‡∏î‡∏ã‡πâ‡∏≤‡∏¢ */
#categoryList{
  text-align:left;
}

/* ‡πÉ‡∏´‡πâ li ‡∏ä‡∏¥‡∏î‡∏ã‡πâ‡∏≤‡∏¢‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô */
#categoryList li{
  text-align:left;
}

/* LIGHT MODE - Soft Eye Comfort */

body.light{
  background:#dde2e7;      /* ‡πÄ‡∏ó‡∏≤‡∏≠‡πà‡∏≠‡∏ô‡∏ô‡∏∏‡πà‡∏° ‡∏•‡∏î‡πÅ‡∏™‡∏á */
  color:#1e293b;
}

body.light .main{
  background:#e3e7ec;
}

body.light .sidebar{
  background:#e7ebf0;      /* ‡πÑ‡∏°‡πà‡∏Ç‡∏≤‡∏ß */
  border-right:1px solid #cfd6dd;
  color:#1f2937;
}

/* ‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà */
body.light #categoryList li{
  background:#eef2f6;
  color:#1f2937;
  border:1px solid #d8dee6;
}

body.light #categoryList li:hover{
  background:#e2e8f0;
}

body.light #categoryList li.active{
  background:#3b82f6;
  color:#fff;
}

/* badge */
body.light .category-count{
  background:#d6dbe1;
  color:#334155;
}

body.light #categoryList li.active .category-count{
  background:rgba(255,255,255,.25);
  color:#fff;
}

/* ‡∏Å‡∏≤‡∏£‡πå‡∏î */
body.light .movie-card{
  background:#f0f3f7;
  box-shadow:0 6px 15px rgba(0,0,0,.05);
}

/* ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏ï‡∏±‡∏ß‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡πÄ‡∏°‡∏ô‡∏π‡∏≠‡πà‡∏≤‡∏ô‡∏á‡πà‡∏≤‡∏¢ */
body.light #categoryList li{
  color:#1f2937;          /* ‡πÄ‡∏ó‡∏≤‡πÄ‡∏Ç‡πâ‡∏° ‡∏≠‡πà‡∏≤‡∏ô‡∏á‡πà‡∏≤‡∏¢ */
  background:#eef2f6;     /* ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏≠‡πà‡∏≠‡∏ô */
  border:1px solid #d8dee6;
}

body.light #categoryList li:hover{
  background:#e2e8f0;
}

body.light #categoryList li.active{
  background:#3b82f6;     /* ‡∏ô‡πâ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏∏‡∏†‡∏≤‡∏û */
  color:#fff;
}

body.light .category-count{
  background:#cfd6dd;
  color:#333;
}

body.light #categoryList li.active .category-count{
  background:rgba(255,255,255,.25);
  color:#fff;
}



/* MAIN */
.main{
  margin-left:280px;
  padding:30px;
  width:100%;
  overflow-y:auto;
  height:100vh;
  
}

.movie-grid{
display:grid;
grid-template-columns:repeat(auto-fill,minmax(180px,1fr));
gap:20px; /* ‡∏•‡∏î‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á‡∏ô‡∏¥‡∏î‡πÉ‡∏´‡πâ‡∏ö‡∏≤‡∏•‡∏≤‡∏ô‡∏ã‡πå */
}
.movie-card{
  background:#1b1b1b;
  border-radius:14px;
  cursor:pointer;
  transition:.3s;
  overflow:hidden;
  box-shadow:0 8px 20px rgba(0,0,0,.4);
}

.movie-card img{
  width:90%;              /* ‡πÑ‡∏°‡πà‡πÄ‡∏ï‡πá‡∏°‡∏Å‡∏£‡∏≠‡∏ö */
  height:220px;           /* ‡∏•‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á‡∏•‡∏á */
  object-fit:cover;
  display:block;
  margin:15px auto 10px;  /* ‡∏à‡∏±‡∏î‡∏Å‡∏•‡∏≤‡∏á + ‡πÄ‡∏ß‡πâ‡∏ô‡∏ö‡∏ô‡∏•‡πà‡∏≤‡∏á */
  border-radius:10px;
}

.movie-card:hover{
transform:translateY(-6px);
box-shadow:0 20px 40px rgba(0,0,0,.6);
}

.movie-title{
  padding:5px 12px 14px;
  font-size:13.5px;      /* ‡∏•‡∏î‡∏Ç‡∏ô‡∏≤‡∏î‡∏à‡∏≤‡∏Å 13px */
  font-weight:300;     /* ‡∏ö‡∏≤‡∏á‡∏•‡∏á (‡∏õ‡∏Å‡∏ï‡∏¥) */
  line-height:1.4em;
  text-align:center;

  white-space:normal;      /* ‡πÉ‡∏´‡πâ‡∏Ç‡∏∂‡πâ‡∏ô‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏î‡πâ */
  overflow:visible;        /* ‡πÑ‡∏°‡πà‡∏ã‡πà‡∏≠‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° */
  word-break:break-word;   /* ‡∏Å‡∏±‡∏ô‡∏Ñ‡∏≥‡∏¢‡∏≤‡∏ß‡∏•‡πâ‡∏ô */
}

/* PLAYER */
#overlay{
position:fixed;
top:0;
left:0;
width:100%;
height:100%;
background:rgba(0,0,0,.8);
backdrop-filter:blur(8px);
opacity:0;
pointer-events:none;
transition:.3s;
z-index:1000;   /* ‡πÅ‡∏Å‡πâ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ */
}

/* ‡∏ß‡∏≤‡∏á‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ */
#overlay.active{
  opacity:1;
  pointer-events:auto;
}

#player-container{
position:fixed;
top:50%;
left:50%;
transform:translate(-50%,-50%) scale(.9);
width:80%;
max-width:1100px;
height:75vh;
background:#000;
border-radius:16px;
overflow:hidden;
box-shadow:0 40px 100px rgba(0,0,0,.8);
opacity:0;
pointer-events:none;
transition:.3s;
z-index:1100;   

}

#player-container.active{
opacity:1;
transform:translate(-50%,-50%) scale(1);
pointer-events:auto;
position:fixed;
}
video,#jw-player{width:100%;height:100%}
.refresh-btn{
background:#00c853;
border:none;
padding:6px;
border-radius:6px;
color:#fff;cursor:pointer;margin-top:8px;
}

.close-btn{
position:fixed;      /* ‡πÉ‡∏ä‡πâ fixed ‡πÅ‡∏ó‡∏ô absolute */
top:20px;
right:20px;
background:red;
color:#fff;
border:none;
border-radius:50%;
width:40px;
height:40px;
font-size:18px;
cursor:pointer;
z-index:1200;        /* ‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ player */
}

.close-btn:hover{
  background:#ff4444;
}

.back-btn{
  background:#ff512f;
  border:none;
  padding:8px 14px;
  border-radius:8px;
  color:#fff;
  font-weight:600;
  cursor:pointer;
  margin-bottom:20px;
  transition:.2s;
}

.back-btn:hover{
  background:#dd2476;
}
#mainMenu button.active{
    background:linear-gradient(90deg,#3b82f6,#6366f1);
    color:#fff;
    font-weight:600;
    box-shadow:0 5px 15px rgba(59,130,246,.3);
}

</style>
</head>

<body>

<div class="sidebar">

<div class="sidebar-section">
<h2>‡∏´‡∏£‡∏£‡∏°‡∏ô‡πâ‡∏≠‡∏¢ ‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå</h2>
</div>


<button id="themeToggle">üåô ‡πÇ‡∏´‡∏°‡∏î‡∏°‡∏∑‡∏î</button>

<div class="sidebar-section">
<h3>üîé ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</h3>
<input type="text" id="searchInput" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡∏ä‡πà‡∏≠‡∏á...">
</div>

<div class="sidebar-section">
<h3>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏´‡∏ô‡∏±‡∏á</h3>
<div id="mainMenu" style="display:flex;flex-direction:column;gap:10px;margin-bottom:20px;"></div>

<hr style="margin:15px 0;">
<h3>üìÅ ‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</h3>
<ul id="categoryList"></ul>
</div>

</div>
<div class="main">

<button id="backHome" class="back-btn">‚Üê ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</button>

<div class="movie-grid" id="movieGrid"></div>

</div>

<div id="overlay"></div>

<div id="player-container">
<button id="closePlayer" class="close-btn">‚úï</button>

<!-- üîΩ ‡∏ß‡∏≤‡∏á‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ -->
<div id="player-type-label"
     style="position:absolute;
            top:15px;
            right:80px;
            background:rgba(0,0,0,.6);
            padding:6px 12px;
            border-radius:20px;
            font-size:13px;
            font-weight:500;
            z-index:1200;">
    ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡πà‡∏ô
</div>
<!-- üîº ‡∏à‡∏ö‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ -->

<!-- üîΩ ‡∏ß‡∏≤‡∏á‡∏õ‡∏∏‡πà‡∏°‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ -->
<div style="position:absolute;top:20px;left:20px;z-index:1200;">
<button id="switchPlayerBtn"
style="padding:6px 10px;border:none;border-radius:6px;background:#2196f3;color:#fff;cursor:pointer;">
üîÅ Auto
</button>
</div>
<!-- üîº ‡∏à‡∏ö‡∏õ‡∏∏‡πà‡∏° -->

<video id="videoPlayer" controls playsinline></video>
<div id="jw-player" style="display:none;"></div>
</div>

<script>

let allChannels = [];
let currentCategory = null;
let playlistCounts = {};   // üëà ‡∏ß‡∏≤‡∏á‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ

let hls=null;
let dashPlayer=null;
let jwInstance=null;

let currentChannel = null;
let forcedPlayer = null; // null = auto | "html5" | "jw"

function setPlayerLabel(text){
    const label = document.getElementById("player-type-label");
    if(label){
        label.textContent = "‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡πà‡∏ô: " + text;
    }
}
const grid=document.getElementById("movieGrid");
const categoryList=document.getElementById("categoryList");
let video=document.getElementById("videoPlayer");
const overlay=document.getElementById("overlay");
const playerContainer=document.getElementById("player-container");
const closeBtn = document.getElementById("closePlayer");

closeBtn.addEventListener("click", () => {
    overlay.classList.remove("active");
    playerContainer.classList.remove("active");
    resetPlayers();
});

playerContainer.addEventListener("click", e => {
    e.stopPropagation();
});

/* ================= PLAYLIST CONFIG ================= */

const PLAYLISTS = [


{
    name: "‡∏´‡∏ô‡∏±‡∏á‡πÉ‡∏´‡∏°‡πà‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡πÄ‡∏î‡∏∑‡∏≠‡∏ô",
    type: "url",
    url: "https://dl.dropboxusercontent.com/scl/fi/qazbt7kg8pbmqwpua3sum/.m3u?rlkey=p8mz84ucqgnl59ft52uz3xh06&dl=1"
},
{
    name: "‡∏´‡∏ô‡∏±‡∏á‡∏ã‡∏π‡∏°",
    type: "url",
    url: "https://dl.dropboxusercontent.com/scl/fi/f6335p7rp7gkjc1mjog3g/.m3u?rlkey=frk7z8lixpyxzt8ozw68hfb7g&dl=1"
},
{
    name: "‡∏´‡∏ô‡∏±‡∏á‡πÉ‡∏´‡∏°‡πà",
    type: "url",
    url: "https://dl.dropboxusercontent.com/scl/fi/wkrcgx4mk0q5we9h198ik/.m3u?rlkey=42zamptxag4k8fy8ncly6ksuw&dl=1"
},
{
    name: "‡∏´‡∏ô‡∏±‡∏á‡∏à‡∏µ‡∏ô",
    type: "url",
    url: "https://dl.dropboxusercontent.com/scl/fi/j6cwjgp7mfsmpfin2y97e/.m3u?rlkey=877zwz3ak6ynalddov6wf1dhg&dl=1"
},
{
    name: "‡∏´‡∏ô‡∏±‡∏á‡∏ù‡∏£‡∏±‡πà‡∏á",
    type: "url",
    url: "https://dl.dropboxusercontent.com/scl/fi/6ewlrevxywn8btkpw5xcq/.m3u?rlkey=a7j7mpj25t6e3sj2qakwu13ze&dl=1"
},
{
    name: "‡∏´‡∏ô‡∏±‡∏á‡πÑ‡∏ó‡∏¢",
    type: "url",
    url: "https://dl.dropboxusercontent.com/scl/fi/na88ndun6pblhyngeajte/.m3u?rlkey=xe7ab7rh9mvxorvk4ank4gzic&dl=1"
},
{
    name: "‡∏´‡∏ô‡∏±‡∏á‡πÄ‡∏Å‡∏≤‡∏´‡∏•‡∏µ",
    type: "url",
    url: "https://dl.dropboxusercontent.com/scl/fi/rsvyqnisoyx29tfer7xko/.m3u?rlkey=ddrg146nk2ae9j81wgwxw1vx6&dl=1"
},
{
    name: "‡∏´‡∏ô‡∏±‡∏á‡∏†‡∏≤‡∏Ñ‡∏ï‡πà‡∏≠",
    type: "url",
    url: "https://dl.dropboxusercontent.com/scl/fi/5bo55hx2zwn7fdpakw472/.m3u?rlkey=iyezay4kqgumkafr94ggiwe3p&dl=1"
},
{
    name: "‡∏´‡∏ô‡∏±‡∏á‡∏≠‡∏¥‡∏ô‡πÄ‡∏î‡∏µ‡∏¢",
    type: "url",
    url: "https://dl.dropboxusercontent.com/scl/fi/9dlsc4byxhzibg5i74vub/Gojek.m3u?rlkey=zxcqa3mr7z9veldpqu9wop4wd&dl=1"
},

];

function parseM3U(data, playlistName){

let channels=[];
const lines=data.split(/\r?\n/);
let current=null;
let pendingDRM=null;

lines.forEach(line=>{
line=line.trim();

if(line.startsWith("#EXTINF")){
    const title=line.substring(line.lastIndexOf(",")+1).trim() || "‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö‡∏ä‡∏∑‡πà‡∏≠";
    const logo=(line.match(/tvg-logo="(.*?)"/)||[])[1]||"";
    current={title,group:playlistName,logo};
    pendingDRM=null;
}
else if(line.includes("license_type=")){
    pendingDRM=pendingDRM||{};
    if(line.toLowerCase().includes("widevine")) pendingDRM.type="widevine";
    if(line.toLowerCase().includes("clearkey")) pendingDRM.type="clearkey";
}


else if(line.includes("license_key=")){
    pendingDRM = pendingDRM || {};

    const value = line.split("=")[1].trim();

    // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö keyid:key
    if(value.includes(":")){
        const parts = value.split(":");
        pendingDRM.keyId = parts[0];
        pendingDRM.key = parts[1];
        pendingDRM.type = "clearkey";
    } else {
        // Widevine license server
        pendingDRM.licenseServer = value;
        pendingDRM.type = "widevine";
    }
}


else if(line && !line.startsWith("#") && current){

    if(line.startsWith("http"))

{
        current.url=line;
        if(pendingDRM) current.drm=pendingDRM;
        channels.push(current);
    }

    current=null;
}

});

return channels;
}

async function loadSinglePlaylist(pl){

    
    grid.innerHTML = "<p>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</p>";
    document.getElementById("backHome").disabled = true;

    try{
        let channels=[];

        if(pl.type==="url"){
            const res=await fetch(pl.url,{cache:"no-store"});
            const text=await res.text();
            channels=parseM3U(text,pl.name);
        }

        allChannels=channels;
        buildCategories();
        renderGrid();

    }catch(e){
        grid.innerHTML="<p>‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</p>";
    }

    document.getElementById("backHome").disabled = false;
}
function buildMainMenu(){

    const menu=document.getElementById("mainMenu");
    menu.innerHTML="";

    PLAYLISTS.forEach(pl=>{
        const btn=document.createElement("button");
        btn.textContent=pl.name;

        btn.style.padding="10px";
        btn.style.fontSize="14px";
        btn.style.textAlign="left";
        btn.style.background="#2c2c2c";
        btn.style.color="#fff";
        btn.style.border="none";
        btn.style.borderRadius="5px";
        btn.style.cursor="pointer";

        btn.onmouseenter=()=>btn.style.background="#444";
        btn.onmouseleave=()=>btn.style.background="#2c2c2c";

        btn.onclick=()=>{
    document.querySelectorAll("#mainMenu button")
    .forEach(b=>b.classList.remove("active"));

    btn.classList.add("active");
    loadSinglePlaylist(pl);
};

        menu.appendChild(btn);
    });
}

buildMainMenu();
document.getElementById("backHome").disabled = true;

document.getElementById("backHome").addEventListener("click", () => {
    window.location.href = "https://nongakka.github.io/doofree/index.html";
});

/* CATEGORY */
function buildCategories(){

categoryList.innerHTML="";
playlistCounts = {};

// üîπ ‡∏ô‡∏±‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ä‡πà‡∏≠‡∏á‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏´‡∏°‡∏ß‡∏î
allChannels.forEach(ch=>{
    if(!playlistCounts[ch.group]){
        playlistCounts[ch.group] = 0;
    }
    playlistCounts[ch.group]++;
});


// üîπ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏´‡∏°‡∏ß‡∏î
const groups = Object.keys(playlistCounts);

groups.forEach((g,i)=>{

    const li=document.createElement("li");
    li.innerHTML = `
    <span>${g}</span>
    <span class="category-count">${playlistCounts[g]}</span>
`;

    if(i===0){
    li.classList.add("active");
    currentCategory = groups[0];
}

    li.onclick=()=>{
        categoryList.querySelectorAll("li")
        .forEach(el=>el.classList.remove("active"));

        li.classList.add("active");
        currentCategory=g;
        renderGrid();
    };

    categoryList.appendChild(li);

});

}



/* SEARCH */
document.getElementById("searchInput").addEventListener("input",renderGrid);

/* GRID */
function renderGrid(){
grid.innerHTML="";
const keyword=document.getElementById("searchInput").value.toLowerCase();
const filtered=allChannels.filter(c=>{
return (!currentCategory || c.group===currentCategory)
&& c.title.toLowerCase().includes(keyword);
});
filtered.forEach(ch=>{
const card=document.createElement("div");
card.className="movie-card";
card.innerHTML=`<img loading="lazy" src="${ch.logo||'https://via.placeholder.com/300x450?text=No+Image'}"><div class="movie-title">${ch.title}</div>`;
card.onclick=()=>playStream(ch);
grid.appendChild(card);
});
}

/* PLAYER RESET */
function resetPlayers(){

    console.log("Reset Players");

    if(hls){
        try{ hls.destroy(); }catch(e){}
        hls = null;
    }

    if(dashPlayer){
        try{ dashPlayer.reset(); }catch(e){}
        dashPlayer = null;
    }
        
    if(window.jwplayer){
        try{ jwplayer("jw-player").remove(); }catch(e){}
    }
    jwInstance = null;

    document.getElementById("jw-player").innerHTML="";
    const oldVideo = document.getElementById("videoPlayer");

    if(oldVideo){

        oldVideo.pause();
        oldVideo.removeAttribute("src");
        oldVideo.load();

        const newVideo = oldVideo.cloneNode(true);
        oldVideo.parentNode.replaceChild(newVideo, oldVideo);

        video = newVideo;

        video.style.display = "block";
        document.getElementById("jw-player").style.display = "none";
    }

    setPlayerLabel("Auto");
}
function startJW(channel){
    video.style.display="none";
    document.getElementById("jw-player").style.display="block";

    jwInstance = jwplayer("jw-player").setup({
        file: channel.url,
        width: "100%",
        height: "100%",
        autostart: true
    });
}

/* PLAY */
function playStream(channel){
    currentChannel = channel; 
    overlay.classList.add("active");
    playerContainer.classList.add("active");
    resetPlayers();

    if(!channel.url) return;

    const url = channel.url.toLowerCase();

// =========================
    // üî• ‡πÇ‡∏´‡∏°‡∏î‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö
    // =========================
    if(forcedPlayer === "jw"){
        setPlayerLabel("JW (‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö)");
        startJWfallback(channel);
        return;
    }

   if(forcedPlayer === "html5"){

    setPlayerLabel("HTML5 (‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö)");

    video.style.display="block";
    document.getElementById("jw-player").style.display="none";

    if(url.includes(".m3u8")){
        video.src = channel.url;
        video.load();
        video.play().catch(()=>{});
    }else{
        alert("HTML5 ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡πÄ‡∏â‡∏û‡∏≤‡∏∞ m3u8");
        return;
    }

    return;
}


    // =========================
    // 1Ô∏è‚É£ ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô MPD + DRM ‚Üí ‡πÉ‡∏ä‡πâ JW ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
    // =========================
    if(url.includes(".mpd") && channel.drm){
        setPlayerLabel("JW (DRM)");
        video.style.display="none";
        document.getElementById("jw-player").style.display="block";

        let config = {
            file: channel.url,
            width: "100%",
            height: "100%",
            autostart: true,
            type: "dash",
            primary: "html5"
        };

        if(channel.drm.type === "widevine"){
            config.drm = {
                widevine: {
                    url: channel.drm.licenseServer
                }
            };
        }

        if(channel.drm.type === "clearkey"){
            config.drm = {
                clearkey: {
                    keyId: channel.drm.keyId,
                    key: channel.drm.key
                }
            };
        }

        jwInstance = jwplayer("jw-player").setup(config);
        return;
    }

    // =========================
    // 2Ô∏è‚É£ MPD ‡πÑ‡∏°‡πà‡∏°‡∏µ DRM ‚Üí dash.js
    // =========================
    if(url.includes(".mpd")){
	setPlayerLabel("dash.js");
        video.style.display="block";
        document.getElementById("jw-player").style.display="none";

        dashPlayer = dashjs.MediaPlayer().create();
        dashPlayer.initialize(video, channel.url, true);

        dashPlayer.on(dashjs.MediaPlayer.events.ERROR, function(e){

    if(e.error){

    try{ dashPlayer.reset(); }catch(e){}
    dashPlayer = null;

    console.log("dash fatal ‚Üí fallback JW");
    startJWfallback(channel);
}

});
            

        return;
    }

    // =========================
    // 3Ô∏è‚É£ M3U8 ‚Üí HLS.js
    // =========================
    if(url.includes(".m3u8")){
	setPlayerLabel("HLS.js");
        video.style.display="block";
        document.getElementById("jw-player").style.display="none";

        if(video.canPlayType("application/vnd.apple.mpegurl")){
            video.src = channel.url;
            video.load();
            video.play().catch(()=>{});
        }
        else if(typeof Hls !== "undefined" && Hls.isSupported()){

            hls = new Hls({
                enableWorker:true
            });

            hls.loadSource(channel.url);
            hls.attachMedia(video);
	    hls.on(Hls.Events.MANIFEST_PARSED, function() {
    video.play().catch(()=>{});
});
            hls.on(Hls.Events.ERROR, function(event, data){
                if(data.fatal){

    try{ hls.destroy(); }catch(e){}
    hls = null;

    console.log("HLS fatal ‚Üí fallback JW");
    startJWfallback(channel);
}
                   
            });
        }
        else{
            startJWfallback(channel);
        }

        return;
    }

    // =========================
    // 4Ô∏è‚É£ ‡∏≠‡∏∑‡πà‡∏ô ‡πÜ ‚Üí JW
    // =========================
    startJWfallback(channel);
}
function startJWfallback(channel){

    setPlayerLabel("JW (Fallback)");
    video.style.display="none";
    document.getElementById("jw-player").style.display="block";

    let type = null;

    if(channel.url.toLowerCase().includes(".mpd")) type = "dash";
    else if(channel.url.toLowerCase().includes(".m3u8")) type = "hls";

    jwInstance = jwplayer("jw-player").setup({
        file: channel.url,
        width: "100%",
        height: "100%",
        autostart: true,
        primary: "html5",
        type: type
    });
}

/* CLOSE */
overlay.onclick=()=>{
overlay.classList.remove("active");
playerContainer.classList.remove("active");
resetPlayers();
};

/* ================= INIT ================= */


document.getElementById("backHome").disabled = true;

if (PLAYLISTS.length > 0) {

    // ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏õ‡∏∏‡πà‡∏°‡πÅ‡∏£‡∏Å active
    const firstBtn = document.querySelector("#mainMenu button");
if(firstBtn){
    firstBtn.click();
}

    
}


/* THEME TOGGLE + SAVE */
const themeBtn = document.getElementById("themeToggle");

// ‡πÇ‡∏´‡∏•‡∏î‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏Ñ‡∏¢‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
if(localStorage.getItem("theme")==="light"){
    document.body.classList.add("light");
}

updateThemeText();

themeBtn.addEventListener("click", () => {
    document.body.classList.toggle("light");

    if(document.body.classList.contains("light")){
        localStorage.setItem("theme","light");
    } else {
        localStorage.setItem("theme","dark");
    }

    updateThemeText();
});

function updateThemeText(){
    if(document.body.classList.contains("light")){
        themeBtn.textContent = "üåô ‡πÇ‡∏´‡∏°‡∏î‡∏°‡∏∑‡∏î";
    } else {
        themeBtn.textContent = "‚òÄÔ∏è ‡πÇ‡∏´‡∏°‡∏î‡∏™‡∏ß‡πà‡∏≤‡∏á";
    }
}

document.getElementById("switchPlayerBtn").addEventListener("click", () => {

if(!currentChannel) return;

if(forcedPlayer === null){
    forcedPlayer = "jw";
}
else if(forcedPlayer === "jw"){
    forcedPlayer = "html5";
}
else{
    forcedPlayer = null;
}

let text = "üîÅ Auto";
if(forcedPlayer === "jw") text = "üîÅ JWPlayer";
if(forcedPlayer === "html5") text = "üîÅ HTML5";

document.getElementById("switchPlayerBtn").textContent = text;

playStream(currentChannel);

});
</script>

</body>

</html>
