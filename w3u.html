<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>W3U to M3U Pro Generator</title>
<style>
body { font-family: Arial; background:#0d1117; color:#fff; padding:20px; }
h1 { color:#58a6ff; }
input, button { margin:5px 5px 5px 0; padding:8px; }
button { background:#238636; border:none; color:#fff; cursor:pointer; }
button:hover { background:#2ea043; }
table { width:100%; border-collapse:collapse; margin-top:15px; }
th, td { border:1px solid #30363d; padding:6px; font-size:13px; }
th { background:#161b22; }
#dropZone {
  border:2px dashed #30363d;
  padding:20px;
  margin-top:10px;
  text-align:center;
}
textarea {
  width:100%;
  height:200px;
  margin-top:15px;
  background:#161b22;
  color:#fff;
}
.stats { margin-top:10px; color:#58a6ff; }
</style>
</head>
<body>

<h1>W3U → M3U Generator PRO</h1>

<input type="file" id="fileInput" accept=".json,.w3u,.m3u">
<label><input type="checkbox" id="filterM3U8" checked> เฉพาะ .m3u8</label>
<input type="text" id="searchBox" placeholder="ค้นหาชื่อ...">
<button onclick="copyM3U()">Copy M3U</button>
<button onclick="downloadM3U()">Download M3U</button>
<button onclick="exportByDomain()">Export แยกตาม Domain</button>
<button onclick="resetAll()" style="background:#8b0000;">Reset</button>

<div id="dropZone">ลากไฟล์มาวางที่นี่</div>

<div class="stats">
รวมทั้งหมด: <span id="totalCount">0</span> |
แสดงผล: <span id="showCount">0</span>
</div>

<table>
<thead>
<tr>
<th>ชื่อ</th>
<th>Domain</th>
<th>URL</th>
</tr>
</thead>
<tbody id="tableBody"></tbody>
</table>

<textarea id="preview" placeholder="Preview M3U..."></textarea>

<script>
let channelList = [];
let groupedData = {};
let generatedM3U = "";

// ===== Utility =====
function getDomain(url){
  try{
    return new URL(url).hostname.replace("www.","");
  }catch{
    return "unknown";
  }
}

// ===== Ultra Extract =====
function ultraExtract(text){

  const results = [];
  const seen = new Set();
  const blockRegex = /{[^{}]*}/g;
  const blocks = text.match(blockRegex) || [];

  blocks.forEach(block => {

    const nameMatch  = block.match(/"name"\s*:\s*"([^"]+)"/i);
    const imageMatch = block.match(/"(image|logo)"\s*:\s*"([^"]+)"/i);
    const urlMatch   = block.match(/https?:\/\/[^\s"'<>]+\.m3u8[^\s"'<>]*/i);

    if(urlMatch){

      const url = urlMatch[0].trim();
      if(seen.has(url)) return;
      seen.add(url);

      results.push({
        name: nameMatch ? nameMatch[1].trim() : "Unknown",
        image: imageMatch ? imageMatch[2].trim() : "",
        url: url,
        domain: getDomain(url)
      });
    }
  });

  return results;
}

// ===== Grouping =====
function groupByDomain(data){

  groupedData = {};

  data.forEach(ch=>{
    if(!groupedData[ch.domain])
      groupedData[ch.domain] = [];
    groupedData[ch.domain].push(ch);
  });

  // เรียง domain
  groupedData = Object.fromEntries(
    Object.entries(groupedData).sort((a,b)=>a[0].localeCompare(b[0]))
  );
}
function applySearchFilter(){

  const keyword = document.getElementById("searchBox").value.toLowerCase();

  if(!keyword){
    groupByDomain(channelList);
  }else{
    const filtered = channelList.filter(ch =>
      ch.name.toLowerCase().includes(keyword) ||
      ch.domain.toLowerCase().includes(keyword)
    );
    groupByDomain(filtered);
  }

  renderTable();
  buildPreview();
}
// ===== Render Table =====
function renderTable(){

  const tbody = document.getElementById("tableBody");
  tbody.innerHTML = "";

  Object.keys(groupedData).forEach(domain=>{

    // Header Row
    const header = document.createElement("tr");
    header.style.background="#161b22";
    header.innerHTML = `
      <td colspan="3" style="cursor:pointer;">
        ▶ ${domain} (${groupedData[domain].length})
      </td>
    `;

    let collapsed = true;

    header.onclick = ()=>{
      collapsed = !collapsed;
      rows.forEach(r=>r.style.display = collapsed ? "none" : "");
      header.cells[0].innerHTML =
        `${collapsed ? "▶" : "▼"} ${domain} (${groupedData[domain].length})`;
    };

    tbody.appendChild(header);

    const rows = [];

    groupedData[domain].forEach(ch=>{
      const tr = document.createElement("tr");
      tr.style.display = "none";

      tr.innerHTML = `
        <td>${ch.name}</td>
        <td>${domain}</td>
        <td>${ch.url}</td>
      `;

      rows.push(tr);
      tbody.appendChild(tr);
    });
  });
}

// ===== Build M3U =====
function buildPreview(){

  generatedM3U = "#EXTM3U\n\n";

  Object.keys(groupedData).forEach(domain=>{
    groupedData[domain].forEach(ch=>{
      generatedM3U +=
        `#EXTINF:-1 tvg-name="${ch.name}" tvg-logo="${ch.image}" group-title="${domain}",${ch.name}\n`;
      generatedM3U += `${ch.url}\n\n`;
    });
  });

  document.getElementById("preview").value = generatedM3U;
}

// ===== Export Separate by Domain =====
function exportByDomain(){

  Object.keys(groupedData).forEach(domain=>{

    let m3u = "#EXTM3U\n\n";

    groupedData[domain].forEach(ch=>{
      m3u +=
        `#EXTINF:-1 tvg-name="${ch.name}" tvg-logo="${ch.image}" group-title="${domain}",${ch.name}\n`;
      m3u += `${ch.url}\n\n`;
    });

    const blob = new Blob([m3u], {type:"application/x-mpegURL"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = domain + ".m3u";
    a.click();
    URL.revokeObjectURL(url);
  });
}

// ===== File Handler =====
function handleFile(text){

  text = text.replace(/^\uFEFF/, "").trim();
  if(!text) return alert("ไฟล์ว่าง");

  channelList = ultraExtract(text);
  if(channelList.length === 0)
    return alert("ไม่พบลิงก์ .m3u8");

  document.getElementById("totalCount").textContent = channelList.length;
  document.getElementById("showCount").textContent = channelList.length;

  groupByDomain(channelList);
  renderTable();
  buildPreview();
}

// ===== Reset =====
function resetAll(){

  channelList = [];
  groupedData = {};
  generatedM3U = "";

  document.getElementById("tableBody").innerHTML="";
  document.getElementById("preview").value="";
  document.getElementById("totalCount").textContent=0;
  document.getElementById("showCount").textContent=0;
  document.getElementById("fileInput").value="";
}

// ===== Download Combined =====
function downloadM3U(){
  if(!generatedM3U) return alert("ไม่มีข้อมูล");

  const blob = new Blob([generatedM3U], {type:"application/x-mpegURL"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "enterprise_playlist.m3u";
  a.click();
  URL.revokeObjectURL(url);
}

// ===== Events =====
document.getElementById("fileInput").addEventListener("change",e=>{
  const reader = new FileReader();
  reader.onload = ev => handleFile(ev.target.result);
  reader.readAsText(e.target.files[0]);
});

document.getElementById("dropZone").addEventListener("dragover",e=>e.preventDefault());
document.getElementById("dropZone").addEventListener("drop",e=>{
  e.preventDefault();
  const reader = new FileReader();
  reader.onload = ev => handleFile(ev.target.result);
  reader.readAsText(e.dataTransfer.files[0]);
});
document.getElementById("searchBox")
  .addEventListener("input", applySearchFilter);
</script>

</body>
</html>
