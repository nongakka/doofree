<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>W3U to M3U Online Generator</title>
<style>
body {
    font-family: Arial;
    background: #0d1117;
    color: #fff;
    padding: 20px;
}
h1 { color: #58a6ff; }
input[type=file] {
    margin: 10px 0;
}
button {
    padding: 8px 15px;
    background: #238636;
    border: none;
    color: white;
    cursor: pointer;
}
button:hover { background: #2ea043; }
table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 20px;
}
th, td {
    border: 1px solid #30363d;
    padding: 6px;
    font-size: 14px;
}
th { background: #161b22; }
</style>
</head>
<body>

<h1>W3U ‚Üí M3U Online Generator</h1>

<input type="file" id="fileInput" accept=".json,.w3u">
<button onclick="downloadM3U()">Download M3U</button>

<table id="channelTable">
<thead>
<tr>
<th>‡∏ä‡∏∑‡πà‡∏≠‡∏ä‡πà‡∏≠‡∏á</th>
<th>‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</th>
<th>URL</th>
</tr>
</thead>
<tbody></tbody>
</table>

<script>
let channelList = [];
let generatedM3U = "";

function extractStations(obj) {
    let list = [];

    function walk(node, parentGroup = "") {
        if (!node || typeof node !== "object") return;

        let currentGroup = parentGroup;

        // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô group
        if (node.name && !node.url) {
            currentGroup = parentGroup
                ? parentGroup + " | " + node.name
                : node.name;
        }

        // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
        if (node.name && typeof node.url === "string") {

            let cleanUrl = node.url.trim();

            // ‡∏Å‡∏£‡∏≠‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞ .m3u8
            if (/\.m3u8(\?|$)/i.test(cleanUrl)) {

                list.push({
                    name: node.name.trim(),
                    url: cleanUrl,
                    image: node.image || "",
                    group: currentGroup || "Default"
                });

            }
        }

        Object.values(node).forEach(value => {
            walk(value, currentGroup);
        });
    }

    walk(obj);
    return list;
}

function buildM3U(data) {
    let result = "#EXTM3U\n\n";
    data.forEach(ch => {
        result += `#EXTINF:-1 tvg-name="${ch.name}" tvg-logo="${ch.image}" group-title="${ch.group}",${ch.name}\n`;
        result += `${ch.url}\n\n`;
    });
    return result;
}
function parseM3U(text) {
    let list = [];
    const lines = text.split("\n");

    let currentName = "";
    let currentGroup = "Default";
    let currentLogo = "";

    lines.forEach(line => {
        line = line.trim();

        if (line.startsWith("#EXTINF")) {

            // ‡∏î‡∏∂‡∏á‡∏ä‡∏∑‡πà‡∏≠
            const nameSplit = line.split(",");
            currentName = nameSplit.length > 1 ? nameSplit[1].trim() : "Unknown";

            // ‡∏î‡∏∂‡∏á group
            const groupMatch = line.match(/group-title="([^"]+)"/);
            currentGroup = groupMatch ? groupMatch[1] : "Default";

            // ‡∏î‡∏∂‡∏á logo
            const logoMatch = line.match(/tvg-logo="([^"]+)"/);
            currentLogo = logoMatch ? logoMatch[1] : "";

        } 
        else if (line && !line.startsWith("#")) {

            if (/\.m3u8(\?|$)/i.test(line)) {
                list.push({
                    name: currentName,
                    url: line,
                    image: currentLogo,
                    group: currentGroup
                });
            }
        }
    });

    return list;
}

function renderTable(data) {
    const tbody = document.querySelector("#channelTable tbody");
    tbody.innerHTML = "";

    data.forEach(ch => {
        const tr = document.createElement("tr");

        const tdName = document.createElement("td");
        tdName.textContent = ch.name;

        const tdGroup = document.createElement("td");
        tdGroup.textContent = ch.group;

        const tdUrl = document.createElement("td");
        tdUrl.textContent = ch.url;

        tr.appendChild(tdName);
        tr.appendChild(tdGroup);
        tr.appendChild(tdUrl);

        tbody.appendChild(tr);
    });
}

document.getElementById("fileInput").addEventListener("change", function(e){
    const file = e.target.files[0];
    const reader = new FileReader();

    reader.onload = function(event) {

        const text = event.target.result.replace(/^\uFEFF/, "").trim();

        try {
            // üîé ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô JSON
            if (text.startsWith("{") || text.startsWith("[")) {
                const jsonData = JSON.parse(text);
                channelList = extractStations(jsonData);
            } 
            // üîé ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô W3U/M3U text
            else if (text.startsWith("#EXTM3U")) {
                channelList = parseM3U(text);
            } 
            else {
                throw new Error("Unknown format");
            }

            generatedM3U = buildM3U(channelList);
            renderTable(channelList);

            console.log("‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£:", channelList.length);

        } catch (err) {
            console.error(err);
            alert("‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á ‡∏´‡∏£‡∏∑‡∏≠ format ‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö");
        }
    };

    reader.readAsText(file);
});

function downloadM3U() {
    if (!generatedM3U) {
        alert("‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•");
        return;
    }
    const blob = new Blob([generatedM3U], { type: "application/x-mpegURL" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "playlist.m3u";
    a.click();
    URL.revokeObjectURL(url);
}
</script>

</body>
</html>
