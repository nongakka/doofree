<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>W3U to M3U Pro Generator</title>
<style>
body { font-family: Arial; background:#0d1117; color:#fff; padding:20px; }
h1 { color:#58a6ff; }
input, button { margin:5px 5px 5px 0; padding:8px; }
button { background:#238636; border:none; color:#fff; cursor:pointer; }
button:hover { background:#2ea043; }
table { width:100%; border-collapse:collapse; margin-top:15px; }
th, td { border:1px solid #30363d; padding:6px; font-size:13px; }
th { background:#161b22; }
#dropZone {
  border:2px dashed #30363d;
  padding:20px;
  margin-top:10px;
  text-align:center;
}
textarea {
  width:100%;
  height:200px;
  margin-top:15px;
  background:#161b22;
  color:#fff;
}
.stats { margin-top:10px; color:#58a6ff; }
</style>
</head>
<body>

<h1>W3U ‚Üí M3U Generator PRO</h1>

<input type="file" id="fileInput" accept=".json,.w3u,.m3u">
<label><input type="checkbox" id="filterM3U8" checked> ‡πÄ‡∏â‡∏û‡∏≤‡∏∞ .m3u8</label>
<input type="text" id="searchBox" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠...">
<button onclick="copyM3U()">Copy M3U</button>
<button onclick="downloadM3U()">Download M3U</button>
<button onclick="resetAll()" style="background:#8b0000;">Reset</button>
<div id="dropZone">‡∏•‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏°‡∏≤‡∏ß‡∏≤‡∏á‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà</div>

<div class="stats">
‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: <span id="totalCount">0</span> |
‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•: <span id="showCount">0</span>
</div>

<table>
<thead>
<tr>
<th>‡∏ä‡∏∑‡πà‡∏≠</th>
<th>‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</th>
<th>URL</th>
</tr>
</thead>
<tbody id="tableBody"></tbody>
</table>

<textarea id="preview" placeholder="Preview M3U..."></textarea>

<script>
let channelList = [];
let generatedM3U = "";

// üî• ‡∏î‡∏∂‡∏á domain ‡∏à‡∏≤‡∏Å URL
function getDomain(url){
  try{
    return new URL(url).hostname.replace("www.","");
  }catch{
    return "unknown";
  }
}

// üî• Ultra Extract + Group by Domain
function ultraExtract(text){

  const results = [];
  const seen = new Set();

  const blockRegex = /{[^{}]*}/g;
  const blocks = text.match(blockRegex) || [];

  blocks.forEach(block => {

    const nameMatch  = block.match(/"name"\s*:\s*"([^"]+)"/i);
    const imageMatch = block.match(/"(image|logo)"\s*:\s*"([^"]+)"/i);
    const urlMatch   = block.match(/https?:\/\/[^\s"'<>]+\.m3u8[^\s"'<>]*/i);

    if(urlMatch){

      const url = urlMatch[0].trim();
      if(seen.has(url)) return;
      seen.add(url);

      const domain = getDomain(url);

      results.push({
        name: nameMatch ? nameMatch[1].trim() : "Unknown",
        image: imageMatch ? imageMatch[2].trim() : "",
        url: url,
        group: domain
      });
    }
  });

  return results;
}

function handleFile(text){

  text = text.replace(/^\uFEFF/, "").trim();

  if(!text){
    alert("‡πÑ‡∏ü‡∏•‡πå‡∏ß‡πà‡∏≤‡∏á");
    return;
  }

  channelList = ultraExtract(text);

  if(channelList.length === 0){
    alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏•‡∏¥‡∏á‡∏Å‡πå .m3u8");
    return;
  }

  document.getElementById("totalCount").textContent = channelList.length;
  document.getElementById("showCount").textContent = channelList.length;

  renderTable(channelList);
  buildPreview(channelList);
}

function renderTable(data){

  const tbody = document.getElementById("tableBody");
  tbody.innerHTML = "";

  data.forEach(ch=>{
    const tr = document.createElement("tr");

    const tdName = document.createElement("td");
    tdName.textContent = ch.name;

    const tdGroup = document.createElement("td");
    tdGroup.textContent = ch.group;

    const tdUrl = document.createElement("td");
    tdUrl.textContent = ch.url;

    tr.appendChild(tdName);
    tr.appendChild(tdGroup);
    tr.appendChild(tdUrl);

    tbody.appendChild(tr);
  });
}

function buildPreview(data){

  generatedM3U = "#EXTM3U\n\n";

  data.forEach(ch=>{
    generatedM3U += `#EXTINF:-1 tvg-name="${ch.name}" tvg-logo="${ch.image}" group-title="${ch.group}",${ch.name}\n`;
    generatedM3U += `${ch.url}\n\n`;
  });

  document.getElementById("preview").value = generatedM3U;
}

function downloadM3U(){
  if(!generatedM3U) return alert("‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•");

  const blob = new Blob([generatedM3U], {type:"application/x-mpegURL"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "playlist_by_domain.m3u";
  a.click();
  URL.revokeObjectURL(url);
}

function copyM3U(){
  if(!generatedM3U) return alert("‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•");
  navigator.clipboard.writeText(generatedM3U);
  alert("Copy ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
}

// üî• ‡∏õ‡∏∏‡πà‡∏°‡∏£‡∏µ‡πÄ‡∏ã‡∏ï
function resetAll(){
  channelList = [];
  generatedM3U = "";

  document.getElementById("tableBody").innerHTML = "";
  document.getElementById("preview").value = "";
  document.getElementById("totalCount").textContent = 0;
  document.getElementById("showCount").textContent = 0;
  document.getElementById("fileInput").value = "";
}

// File Input
document.getElementById("fileInput").addEventListener("change",e=>{
  const reader = new FileReader();
  reader.onload = ev => handleFile(ev.target.result);
  reader.readAsText(e.target.files[0]);
});

// Drag Drop
document.getElementById("dropZone").addEventListener("dragover",e=>e.preventDefault());
document.getElementById("dropZone").addEventListener("drop",e=>{
  e.preventDefault();
  const reader = new FileReader();
  reader.onload = ev => handleFile(ev.target.result);
  reader.readAsText(e.dataTransfer.files[0]);
});
</script>

</body>
</html>
