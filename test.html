<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>‡∏´‡∏£‡∏£‡∏°‡∏ô‡πâ‡∏≠‡∏¢ ‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå</title>

<link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600&display=swap" rel="stylesheet">

<script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
<script src="https://cdn.dashjs.org/latest/dash.all.min.js"></script>
<script src="https://ssl.p.jwpcdn.com/player/v/8.26.0/jwplayer.js"></script>
<script>jwplayer.key="XSuP4qMl+9tK17QNb+4+th2Pm9AWgMO/cYH8CI0HGGr7bdjo";</script>

<style>
:root{
--bg:#0f0f0f;
--card:#1b1b1b;
--accent:#f5c518;
}
*{box-sizing:border-box}
body{
margin:0;
font-family:'Kanit',sans-serif;
background:#0b0b0b;
color:#fff;
display:flex;
}

.playlist-box{
background:#222;
padding:8px;
margin-bottom:6px;
border-radius:6px;
cursor:pointer;
display:flex;
justify-content:space-between;
align-items:center;
gap:6px;
}

.playlist-name{
flex:1;
white-space:nowrap;
overflow:hidden;
text-overflow:ellipsis;
font-size:13px;
}

.playlist-actions{
display:flex;
gap:4px;
}

.playlist-actions button{
border:none;
padding:3px 6px;
border-radius:4px;
color:#fff;
cursor:pointer;
font-size:12px;
}

.playlist-box.active{
background:#333;
border-left:3px solid var(--accent);
}

/* SIDEBAR */
.sidebar{
  width:280px;
  background:#0f0f0f;
  height:100vh;
  padding:5px 20px 20px 20px; /* ‡∏•‡∏î padding-top */
  position:fixed;
  left:0;
  top:0;
  border-right:1px solid #222;
  overflow-y:auto;
  transition:.3s;
  z-index:100;
}


/* ‡∏õ‡∏∏‡πà‡∏° */

.sidebar-section{
  margin:20px 0;
  padding-bottom:15px;
  border-bottom:1px solid #1f1f1f;
  text-align:center;
}

.sidebar-section:last-child{
border-bottom:none;
}

.sidebar h2{
  color:var(--accent);
  margin:0 0 5px 0;   /* ‡∏ö‡∏ô ‡∏Ç‡∏ß‡∏≤ ‡∏•‡πà‡∏≤‡∏á ‡∏ã‡πâ‡∏≤‡∏¢ */
  padding-top:0;
}

.sidebar h3{
font-size:14px;
margin-bottom:5px;
color:#aaa;
text-transform:uppercase;
letter-spacing:.5px;
}

.sidebar input{
width:100%;
margin-bottom:8px;
padding:8px;
background:#1c1c1c;
border:1px solid #222;
color:#fff;
border-radius:6px;
}

.sidebar button{
width:100%;
padding:8px;
margin-bottom:8px;
background:var(--accent);
border:none;
border-radius:6px;
cursor:pointer;
font-weight:600;
}

.sidebar ul{
list-style:none;
padding:0;
margin:0;
}

.sidebar li{
padding:8px;
border-radius:6px;
cursor:pointer;
font-size:13px;
}

.sidebar li:hover,
.sidebar li.active{
background:#222;
}

.sidebar-section h2{
  font-size:18px;
  font-weight:600;
  letter-spacing:1px;
  margin:0;
  position:relative;
  display:inline-block;
  padding-bottom:8px;
}

/* ‡πÄ‡∏™‡πâ‡∏ô‡πÑ‡∏•‡πà‡∏™‡∏µ‡πÉ‡∏ï‡πâ‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠ */
.sidebar-section h2::after{
  content:"";
  position:absolute;
  left:50%;
  transform:translateX(-50%);
  bottom:0;
  width:60%;
  height:3px;
  border-radius:10px;
  background:linear-gradient(90deg,#ff512f,#dd2476);
}

/* ‡πÉ‡∏´‡πâ‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏≠‡∏¢‡∏π‡πà‡∏Å‡∏•‡∏≤‡∏á */
.sidebar-section h2,
.sidebar-section h3{
  text-align:center;
}

/* ‡πÅ‡∏ï‡πà‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ playlist ‡∏ä‡∏¥‡∏î‡∏ã‡πâ‡∏≤‡∏¢ */
#playlistContainer{
  text-align:left;
}

/* ‡πÅ‡∏ï‡πà‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏ä‡∏¥‡∏î‡∏ã‡πâ‡∏≤‡∏¢ */
#categoryList{
  text-align:left;
}

/* ‡πÉ‡∏´‡πâ li ‡∏ä‡∏¥‡∏î‡∏ã‡πâ‡∏≤‡∏¢‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô */
#categoryList li{
  text-align:left;
}

/* LIGHT MODE - Soft Muted */

body.light{
  background:#e6e9ee;     /* ‡πÄ‡∏ó‡∏≤‡∏≠‡πà‡∏≠‡∏ô‡∏ô‡∏∏‡πà‡∏° */
  color:#222;
}

body.light .sidebar{
  background:#f1f3f6;     /* ‡πÑ‡∏°‡πà‡∏Ç‡∏≤‡∏ß‡∏à‡∏±‡∏î */
  border-right:1px solid #d2d8df;
}

body.light .sidebar h2{
  color:#334155;          /* ‡∏ô‡πâ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏ó‡∏≤‡πÄ‡∏Ç‡πâ‡∏° */
}

body.light .sidebar h3{
  color:#6b7280;
}

body.light .sidebar li:hover,
body.light .sidebar li.active{
  background:#dde3ea;
}

body.light .playlist-box{
  background:#e4e8ee;
}

body.light .movie-card{
  background:#f5f7fa;
  box-shadow:0 6px 15px rgba(0,0,0,.06);
}

body.light .main{
  background:#e9edf2;
}

/* MAIN */
.main{
  margin-left:280px;
  padding:30px;
  width:100%;
  overflow-y:auto;
  height:100vh;
  
}

.movie-grid{
display:grid;
grid-template-columns:repeat(auto-fill,minmax(200px,1fr));
gap:25px;
}
.movie-card{
background:var(--card);
border-radius:12px;
overflow:hidden;
cursor:pointer;
transition:.3s;
}
.movie-card img{
width:100%;height:300px;object-fit:cover;
}
.movie-card:hover{
transform:translateY(-6px);
box-shadow:0 20px 40px rgba(0,0,0,.6);
}
.movie-title{padding:10px;font-size:14px}

/* PLAYER */
#overlay{
position:fixed;
top:0;
left:0;
width:100%;
height:100%;
background:rgba(0,0,0,.8);
backdrop-filter:blur(8px);
opacity:0;
pointer-events:none;
transition:.3s;
z-index:1000;   /* ‡πÅ‡∏Å‡πâ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ */
}

/* ‡∏ß‡∏≤‡∏á‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ */
#overlay.active{
  opacity:1;
  pointer-events:auto;
}

#player-container{
position:fixed;
top:50%;
left:50%;
transform:translate(-50%,-50%) scale(.9);
width:80%;
max-width:1100px;
height:75vh;
background:#000;
border-radius:16px;
overflow:hidden;
box-shadow:0 40px 100px rgba(0,0,0,.8);
opacity:0;
pointer-events:none;
transition:.3s;
z-index:1100;   

}

#player-container.active{
opacity:1;
transform:translate(-50%,-50%) scale(1);
pointer-events:auto;
position:fixed;
}
video,#jw-player{width:100%;height:100%}
.refresh-btn{
background:#00c853;
border:none;
padding:6px;
border-radius:6px;
color:#fff;cursor:pointer;margin-top:8px;
}

.close-btn{
position:fixed;      /* ‡πÉ‡∏ä‡πâ fixed ‡πÅ‡∏ó‡∏ô absolute */
top:20px;
right:20px;
background:red;
color:#fff;
border:none;
border-radius:50%;
width:40px;
height:40px;
font-size:18px;
cursor:pointer;
z-index:1200;        /* ‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ player */
}

.close-btn:hover{
  background:#ff4444;
}

.back-btn{
  background:#ff512f;
  border:none;
  padding:8px 14px;
  border-radius:8px;
  color:#fff;
  font-weight:600;
  cursor:pointer;
  margin-bottom:20px;
  transition:.2s;
}

.back-btn:hover{
  background:#dd2476;
}

</style>
</head>

<body>

<div class="sidebar">

<div class="sidebar-section">
<h2>‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏•‡πà‡∏ô‡πÑ‡∏ü‡∏•‡πå M3U</h2>
</div>

<button id="themeToggle">üåô ‡πÇ‡∏´‡∏°‡∏î‡∏°‡∏∑‡∏î</button>

<div class="sidebar-section">
<input type="file" id="fileInput" accept=".m3u,.m3u8">
<input type="text" id="urlInput" placeholder="‡∏ß‡∏≤‡∏á URL m3u">
<button onclick="loadURL()">‡πÇ‡∏´‡∏•‡∏î URL</button>
</div>

<div class="sidebar-section">
<h3>üìÇ ‡∏ä‡πà‡∏≠‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°</h3>
<div id="playlistContainer"></div>
</div>

<div class="sidebar-section">
<h3>üîé ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</h3>
<input type="text" id="searchInput" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡∏ä‡πà‡∏≠‡∏á...">
</div>

<div class="sidebar-section">
<h3>üìÅ ‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</h3>
<ul id="categoryList"></ul>
</div>

</div>
<div class="main">

<button id="backHome" class="back-btn">‚Üê ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</button>

<div class="movie-grid" id="movieGrid"></div>

</div>

<div id="overlay"></div>

<div id="player-container">
<button id="closePlayer" class="close-btn">‚úï</button>
<video id="videoPlayer" controls playsinline></video>
<div id="jw-player" style="display:none;"></div>
</div>

<script>

let playlists = JSON.parse(localStorage.getItem("iptv_playlists")) || [];
let activePlaylistIndex = null;
let allChannels = [];
let currentCategory = "‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î";

let hls=null;
let dashPlayer=null;
let jwInstance=null;

const grid=document.getElementById("movieGrid");
const categoryList=document.getElementById("categoryList");
const video=document.getElementById("videoPlayer");
const overlay=document.getElementById("overlay");
const playerContainer=document.getElementById("player-container");
const closeBtn = document.getElementById("closePlayer");

closeBtn.addEventListener("click", () => {
    overlay.classList.remove("active");
    playerContainer.classList.remove("active");
    resetPlayers();
});

playerContainer.addEventListener("click", e => {
    e.stopPropagation();
});
const playlistUI = document.getElementById("playlistContainer");

/* SAVE */
function savePlaylists(){
localStorage.setItem("iptv_playlists",JSON.stringify(playlists));
}

const themeToggle = document.getElementById("themeToggle");

// ‡πÇ‡∏´‡∏•‡∏î‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏Ñ‡∏¢‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
if(localStorage.getItem("theme")==="light"){
    document.body.classList.add("light");
    themeToggle.textContent="‚òÄÔ∏è ‡πÇ‡∏´‡∏°‡∏î‡∏™‡∏ß‡πà‡∏≤‡∏á";
}

themeToggle.onclick=()=>{
    document.body.classList.toggle("light");

    if(document.body.classList.contains("light")){
        localStorage.setItem("theme","light");
        themeToggle.textContent="‚òÄÔ∏è ‡πÇ‡∏´‡∏°‡∏î‡∏™‡∏ß‡πà‡∏≤‡∏á";
    }else{
        localStorage.setItem("theme","dark");
        themeToggle.textContent="üåô ‡πÇ‡∏´‡∏°‡∏î‡∏°‡∏∑‡∏î";
    }
};

document.getElementById("backHome").onclick = () => {
    window.location.href = "https://nongakka.github.io/doofree/index.html"; 
};

/* RENDER PLAYLIST UI */
function renderPlaylists(){
playlistUI.innerHTML="";

playlists.forEach((pl,index)=>{

// ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô playlist ‡πÄ‡∏™‡∏µ‡∏¢
if(!pl.channels) pl.channels = [];

const div=document.createElement("div");
div.className="playlist-box";

div.innerHTML=`
<div class="playlist-name" title="${pl.name}">
${pl.name} (${pl.channels.length})
</div>

<div class="playlist-actions">
<button onclick="refreshOne(${index});event.stopPropagation();" 
style="background:#00c853;">üîÑ</button>

<button onclick="deletePlaylist(${index});event.stopPropagation();" 
style="background:red;">‚úï</button>
</div>
`;

if(index===activePlaylistIndex){
    div.classList.add("active");
}


div.onclick=()=>{
activePlaylistIndex=index;
allChannels=pl.channels;
currentCategory="‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î";
buildCategories();
renderGrid();
};

playlistUI.appendChild(div);

});
}

/* DELETE */
function deletePlaylist(index){
if(!confirm("‡∏•‡∏ö Playlist ‡∏ô‡∏µ‡πâ?")) return;

playlists.splice(index,1);

if(activePlaylistIndex===index){
activePlaylistIndex=null;
allChannels=[];
grid.innerHTML="";
categoryList.innerHTML="";
}

savePlaylists();
renderPlaylists();
}

/* REFRESH ONE */
function refreshOne(index){
const pl=playlists[index];
if(!pl.source) return alert("Playlist ‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà URL");

fetch(pl.source+"?t="+Date.now())
.then(r=>r.text())
.then(text=>{
parseM3U(text,pl.source,index);
alert("‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‚úÖ");
})
.catch(()=>alert("‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‚ùå"));
}

/* FILE LOAD */
document.getElementById("fileInput").addEventListener("change",e=>{
if(!e.target.files.length) return;

const reader=new FileReader();
reader.onload=()=>{
parseM3U(reader.result,null,null,e.target.files[0].name);
};
reader.readAsText(e.target.files[0]);
});

/* URL LOAD */
function loadURL(){
const url=document.getElementById("urlInput").value.trim();
if(!url) return;
fetch(url)
.then(r=>r.text())
.then(text=>{
parseM3U(text,url);
})
.catch(()=>alert("‡πÇ‡∏´‡∏•‡∏î URL ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à"));
}

/* PARSE */
function parseM3U(data,source,indexOverride=null,fileName=null){

let channels=[];
const lines=data.split(/\r?\n/);
let current=null;
let pendingDRM=null;

lines.forEach(line=>{
line=line.trim();

if(line.startsWith("#EXTINF")){
    const title=line.substring(line.lastIndexOf(",")+1).trim() || "‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö‡∏ä‡∏∑‡πà‡∏≠";
    const group=(line.match(/group-title="(.*?)"/)||[])[1]||"‡∏≠‡∏∑‡πà‡∏ô‡πÜ";
    const logo=(line.match(/tvg-logo="(.*?)"/)||[])[1]||"";
    current={title,group,logo};
    pendingDRM=null;
}

else if(line.includes("license_type=")){
    pendingDRM=pendingDRM||{};
    if(line.toLowerCase().includes("widevine")) pendingDRM.type="widevine";
    if(line.toLowerCase().includes("clearkey")) pendingDRM.type="clearkey";
}

else if(line.includes("license_key=")){
    pendingDRM = pendingDRM || {};
    const value = line.substring(line.indexOf("license_key=") + 12).trim();

    if(value.startsWith("http")){
        // Widevine license server
        pendingDRM.type = "widevine";
        pendingDRM.licenseServer = value;
    }else{
        // ClearKey
        const parts = value.split(":");
        if(parts.length === 2){
            pendingDRM.type = "clearkey";
            pendingDRM.keyId = parts[0].trim();
            pendingDRM.key = parts[1].trim();
        }
    }
}

else if(line && !line.startsWith("#") && current){

    // ‡∏£‡∏±‡∏ö‡∏ó‡∏∏‡∏Å URL ‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô http
    if(line.startsWith("http")){

        current.url = line;

        if(pendingDRM) current.drm = pendingDRM;

        channels.push(current);
    }

    current = null;
}

});

document.getElementById("searchInput").value="";

const playlistData={
    name:fileName || (source ? new URL(source).hostname : "Local File"),
    source:source,
    channels:channels
};

if(indexOverride!==null){
    playlists[indexOverride]=playlistData;
    activePlaylistIndex=indexOverride;
}else{
    playlists.push(playlistData);
    activePlaylistIndex=playlists.length-1;
}

savePlaylists();
renderPlaylists();

allChannels=channels;
currentCategory="‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î";
buildCategories();
renderGrid();
}

/* CATEGORY */
function buildCategories(){
const groups=["‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î",...new Set(allChannels.map(c=>c.group))];
categoryList.innerHTML="";

groups.forEach((g,i)=>{
const li=document.createElement("li");
li.textContent=g;

if(i===0){
li.classList.add("active");
}

li.onclick=()=>{
categoryList.querySelectorAll("li")
.forEach(el=>el.classList.remove("active"));
li.classList.add("active");
currentCategory=g;
renderGrid();
};

categoryList.appendChild(li);
});
}

/* SEARCH */
document.getElementById("searchInput").addEventListener("input",renderGrid);

/* GRID */
function renderGrid(){
grid.innerHTML="";
const keyword=document.getElementById("searchInput").value.toLowerCase();
const filtered=allChannels.filter(c=>{
return (currentCategory==="‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î"||c.group===currentCategory)
&& c.title.toLowerCase().includes(keyword);
});
filtered.forEach(ch=>{
const card=document.createElement("div");
card.className="movie-card";
card.innerHTML=`<img loading="lazy" src="${ch.logo||'https://via.placeholder.com/300x450?text=No+Image'}"><div class="movie-title">${ch.title}</div>`;
card.onclick=()=>playStream(ch);
grid.appendChild(card);
});
}

/* PLAYER RESET */
function resetPlayers(){
if(hls){hls.destroy();hls=null;}
if(dashPlayer){dashPlayer.reset();dashPlayer=null;}
if(jwInstance){
    jwInstance.remove();
    document.getElementById("jw-player").innerHTML="";  // üëà ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ
    jwInstance=null;
}
video.pause();
video.removeAttribute("src");
video.load();
document.getElementById("jw-player").style.display="none";
video.style.display="block";
}


function hexToBase64(hex){
    if(!hex) return "";
    const bytes = hex.match(/.{1,2}/g).map(b => parseInt(b,16));
    return btoa(String.fromCharCode(...bytes));
}

/* PLAY */

function playStream(channel){

    overlay.classList.add("active");
    playerContainer.classList.add("active");
    resetPlayers();

    video.style.display = "none";
    document.getElementById("jw-player").style.display = "block";

    let setupConfig = {
        file: channel.url,
        width: "100%",
        height: "100%",
        autostart: true,
        primary: "html5"
    };

    if(channel.url.includes(".mpd")){
        setupConfig.type = "dash";
    }

    if(channel.url.includes(".m3u8")){
        setupConfig.type = "hls";
    }

    if(channel.drm){

        setupConfig.type = "dash";

        if(channel.drm.type === "widevine"){
            setupConfig.drm = {
                widevine: {
                    url: channel.drm.licenseServer
                }
            };
        }

        if(channel.drm.type === "clearkey"){

    setupConfig.drm = {
        clearkey: {
            keyId: channel.drm.keyId,
            key: channel.drm.key
        }
    };
}
    }

    // ‚úÖ ‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡∏¢‡∏π‡πà‡∏ô‡∏≠‡∏Å if(drm)
    jwInstance = jwplayer("jw-player").setup(setupConfig);
}
    

/* CLOSE */
overlay.onclick=()=>{
overlay.classList.remove("active");
playerContainer.classList.remove("active");
resetPlayers();
};

/* INIT */
renderPlaylists();


</script>

</body>
</html>
