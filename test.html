<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>‡∏´‡∏£‡∏£‡∏°‡∏ô‡πâ‡∏≠‡∏¢ ‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå</title>

<link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
<script src="https://cdn.dashjs.org/latest/dash.all.min.js"></script>

<style>
/* ===== CSS ‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ‡πÑ‡∏°‡πà‡∏•‡∏ö ===== */
:root{
--accent:#7b2cff;
--bg:#0a0614;
--card:#141022;
--border:#2a1f44;
}
*{box-sizing:border-box}
body{margin:0;font-family:'Kanit',sans-serif;background:#000;color:#fff;overflow:hidden}
#player-container{position:fixed;top:0;left:0;width:100%;height:100%;background:#000;transition:.3s;z-index:1}
#player-container.blur{filter:blur(10px) brightness(.4)}
video{width:100%;height:100%;object-fit:contain;background:#000}
#overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.7);transition:.3s;z-index:8}
#overlay.hide{opacity:0;visibility:hidden}
#menu{position:fixed;top:0;left:0;width:360px;height:100%;background:var(--bg);border-right:1px solid var(--border);overflow-y:auto;transition:.4s;z-index:10}
#menu.hide{transform:translateX(-100%)}
.control-box{padding:12px;border-bottom:1px solid var(--border)}
.control-box input{width:100%;padding:6px;margin-bottom:6px;background:#111;border:1px solid var(--border);color:#fff;border-radius:6px}
.control-box button{width:100%;padding:6px;margin-bottom:6px;background:var(--accent);border:none;color:#fff;border-radius:6px;cursor:pointer}
.category{margin:10px;background:var(--card);border:1px solid var(--border);border-radius:10px}
.category-header{padding:8px 12px;cursor:pointer;display:flex;justify-content:space-between;align-items:center;background:#1b1530}
.category-content{display:none;padding:6px}
.category.active>.category-content{display:block}
.channel{display:flex;align-items:center;padding:6px;margin-bottom:6px;background:#1a142b;border-radius:8px;cursor:pointer;transition:.2s}
.channel:hover{background:var(--accent)}
.channel img{width:32px;height:32px;object-fit:contain;margin-right:8px}
#preview-left{position:absolute;top:50%;left:370px;transform:translateY(-50%) scale(.95);width:280px;height:400px;background:#000;border-radius:14px;overflow:hidden;opacity:0;transition:.25s;z-index:9999;pointer-events:none;box-shadow:0 0 30px rgba(0,0,0,.7);}
#preview-left.active{opacity:1;transform:translateY(-50%) scale(1);box-shadow:0 0 40px rgba(123,44,255,.6);}
#preview-left img{width:100%;height:100%;object-fit:contain;}
</style>
</head>

<body>

<div id="player-container" class="blur">
<video id="video" controls autoplay></video>
</div>

<div id="overlay"></div>

<div id="menu">
<div class="control-box">
<input type="file" id="fileInput" accept=".m3u,.m3u8">
<input type="text" id="urlInput" placeholder="‡∏ß‡∏≤‡∏á URL m3u">
<button onclick="addURL()">‡πÄ‡∏û‡∏¥‡πà‡∏° URL</button>
<input type="text" id="search" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤...">
</div>
<div id="playlistContainer"></div>
</div>

<div id="preview-left"><img id="previewImg"></div>

<script>

let playlists=JSON.parse(localStorage.getItem("iptv_playlists"))||[];
let hls=null;
let dashPlayer=null;

function save(){
localStorage.setItem("iptv_playlists",JSON.stringify(playlists));
}

/* ===== FIX parse ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏°‡πà‡∏°‡∏µ #EXTM3U ===== */
function parseM3U(text){
const lines=text.replace(/\r/g,"").split("\n");
let current={},list=[];
for(let line of lines){
line=line.trim();
if(line.startsWith("#EXTINF")){
const name=line.match(/,(.*)$/);
const logo=line.match(/tvg-logo="(.*?)"/);
const group=line.match(/group-title="(.*?)"/);
const sub=line.match(/tvg-id="(.*?)"/);
current={
title:name?name[1].trim():"‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ä‡∏∑‡πà‡∏≠",
logo:logo?logo[1]:"",
group:group?group[1]:"‡∏≠‡∏∑‡πà‡∏ô‡πÜ",
subgroup:sub?sub[1]:null
};
}else if(line && !line.startsWith("#")){
current.url=line.trim();
list.push({...current});
}
}
return list;
}

/* ===== FIX render ‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏ä‡∏∑‡πà‡∏≠‡∏¢‡∏≤‡∏ß‡∏•‡πâ‡∏ô ===== */
function shortName(name){
return name.length>40?name.substring(0,40)+"...":name;
}

function render(){
const container=document.getElementById("playlistContainer");
container.innerHTML="";
playlists.forEach((pl,i)=>{
const box=document.createElement("div");
box.className="category";
const head=document.createElement("div");
head.className="category-header";
head.innerHTML=`<span>üìÇ ${shortName(pl.name)}</span>
<button onclick="event.stopPropagation();deletePlaylist(${i})">‡∏•‡∏ö</button>`;
head.onclick=()=>box.classList.toggle("active");
const content=document.createElement("div");
content.className="category-content";
const groups={};
pl.data.forEach(ch=>{
if(!groups[ch.group]) groups[ch.group]=[];
groups[ch.group].push(ch);
});
for(let g in groups){
const mainGroup=document.createElement("div");
mainGroup.className="category";
const gHead=document.createElement("div");
gHead.className="category-header";
gHead.innerHTML=`<span>üìÅ ${g}</span>`;
gHead.onclick=()=>mainGroup.classList.toggle("active");
const gContent=document.createElement("div");
gContent.className="category-content";
groups[g].forEach(ch=>{
gContent.appendChild(createChannel(ch));
});
mainGroup.appendChild(gHead);
mainGroup.appendChild(gContent);
content.appendChild(mainGroup);
}
box.appendChild(head);
box.appendChild(content);
container.appendChild(box);
});
}

function createChannel(ch){
const div=document.createElement("div");
div.className="channel";
div.innerHTML=`
${ch.logo?`<img src="${ch.logo}" onerror="this.style.display='none'">`:""}
<span>${ch.title}</span>`;
div.onclick=()=>play(ch);
return div;
}

function deletePlaylist(i){
if(confirm("‡∏•‡∏ö Playlist ‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?")){
playlists.splice(i,1);
save();render();
}
}

/* ===== FIX ‡πÄ‡∏•‡πà‡∏ô mpd + m3u8 ‡∏Ñ‡∏£‡∏ö ===== */
function play(channel){
const video=document.getElementById("video");
if(hls){try{hls.destroy()}catch(e){} hls=null;}
if(dashPlayer){try{dashPlayer.reset()}catch(e){} dashPlayer=null;}
video.pause();video.removeAttribute("src");video.load();

if(channel.url.includes(".m3u8")){
if(video.canPlayType("application/vnd.apple.mpegurl")){
video.src=channel.url;video.play();
}else if(Hls.isSupported()){
hls=new Hls();
hls.loadSource(channel.url);
hls.attachMedia(video);
hls.on(Hls.Events.MANIFEST_PARSED,()=>video.play());
}
}
else if(channel.url.includes(".mpd")){
dashPlayer=dashjs.MediaPlayer().create();
dashPlayer.initialize(video,channel.url,true);
}
else{
video.src=channel.url;
video.play();
}
}

/* ===== FIX ‡πÇ‡∏´‡∏•‡∏î URL ‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡πÄ‡∏á‡∏µ‡∏¢‡∏ö ===== */
async function addURL(){
const url=document.getElementById("urlInput").value.trim();
if(!url)return alert("‡πÉ‡∏™‡πà URL ‡∏Å‡πà‡∏≠‡∏ô");
try{
const res=await fetch(url,{mode:"cors"});
if(!res.ok) throw new Error("‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ");
const text=await res.text();
const data=parseM3U(text);
if(!data.length) throw new Error("‡πÑ‡∏ü‡∏•‡πå‡∏ß‡πà‡∏≤‡∏á");
playlists.push({name:url,data});
save();
render();
alert("‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
}catch(err){
alert("‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ ‡∏≠‡∏≤‡∏à‡∏ï‡∏¥‡∏î CORS ‡∏´‡∏£‡∏∑‡∏≠ URL ‡∏ú‡∏¥‡∏î");
}
}

document.getElementById("fileInput").addEventListener("change",e=>{
const file=e.target.files[0];
if(!file)return;
const reader=new FileReader();
reader.onload=ev=>{
const data=parseM3U(ev.target.result);
playlists.push({name:file.name,data});
save();
render();
};
reader.readAsText(file);
});

render();
</script>
</body>
</html>
